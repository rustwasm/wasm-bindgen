use js_sys::Array;
use wasm_bindgen::prelude::*;
use web_sys::{Blob, BlobPropertyBag, Url}; // needs to be added to Cargo.toml

#[wasm_bindgen]
extern "C" {
    #[wasm_bindgen(js_namespace = console)]
    fn log(s: &str);
}

// it looks like `raytrace_parallel.js` and `worker.js` in one minified version
// so they are in the same scope
// `worker.js` does not have `importScripts('raytrace_parallel.js')` line
const WORKER_CODE: &str = r#"let wasm_bindgen;!function(){const n={};let e,t;const _=new Array(32).fill(void 0);function r(n){return _[n]}_.push(void 0,null,!0,!1);let o=0,i=null;function c(){return null!==i&&i.buffer===e.__wbindgen_export_0.buffer||(i=new Uint8Array(e.__wbindgen_export_0.buffer)),i}let a=new TextEncoder("utf-8");const b=function(n,e){const t=a.encode(n);return e.set(t),{read:n.length,written:t.length}};function s(n,e,t){if(void 0===t){const t=a.encode(n),_=e(t.length);return c().subarray(_,_+t.length).set(t),o=t.length,_}let _=n.length,r=e(_);const i=c();let s=0;for(;s<_;s++){const e=n.charCodeAt(s);if(e>127)break;i[r+s]=e}if(s!==_){0!==s&&(n=n.slice(s)),r=t(r,_,_=s+3*n.length);const e=c().subarray(r+s,r+_);s+=b(n,e).written}return o=s,r}let u=null;function w(){return null!==u&&u.buffer===e.__wbindgen_export_0.buffer||(u=new Int32Array(e.__wbindgen_export_0.buffer)),u}let g=_.length;function f(n){const e=r(n);return function(n){n<36||(_[n]=g,g=n)}(n),e}let l=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});function d(n,e){return l.decode(c().slice(n,n+e))}function p(n){g===_.length&&_.push(_.length+1);const e=g;return g=_[e],_[e]=n,e}function m(n,t,_,r){const o={a:n,b:t,cnt:1,dtor:_},i=(...n)=>{o.cnt++;const t=o.a;o.a=0;try{return r(t,o.b,...n)}finally{0==--o.cnt?e.__wbindgen_export_3.get(o.dtor)(t,o.b):o.a=t}};return i.original=o,i}function y(n,t,_){e._dyn_core__ops__function__FnMut__A____Output___R_as_wasm_bindgen__closure__WasmClosure___describe__invoke__h0e98537eab6ab96f(n,t,p(_))}function h(n,t,_){e._dyn_core__ops__function__FnMut__A____Output___R_as_wasm_bindgen__closure__WasmClosure___describe__invoke__h11d8a2a7e49bd85a(n,t,p(_))}function v(n,t,_){e._dyn_core__ops__function__FnMut__A____Output___R_as_wasm_bindgen__closure__WasmClosure___describe__invoke__h11d8a2a7e49bd85a(n,t,p(_))}l.decode();let A=32;function j(n){return function(){try{return n.apply(this,arguments)}catch(n){e.__wbindgen_exn_store(p(n))}}}n.child_entry_point=function(n){e.child_entry_point(n)};class O{static __wrap(n){const e=Object.create(O.prototype);return e.ptr=n,e}free(){const n=this.ptr;this.ptr=0,e.__wbg_renderingscene_free(n)}promise(){return f(e.renderingscene_promise(this.ptr))}imageSoFar(){return f(e.renderingscene_imageSoFar(this.ptr))}}n.RenderingScene=O;class R{static __wrap(n){const e=Object.create(R.prototype);return e.ptr=n,e}free(){const n=this.ptr;this.ptr=0,e.__wbg_scene_free(n)}constructor(n){try{var t=e.scene_new(function(n){if(1==A)throw new Error("out of js stack");return _[--A]=n,A}(n));return R.__wrap(t)}finally{_[A++]=void 0}}render(n,t){var _=this.ptr;this.ptr=0,function(n,e){if(!(n instanceof e))throw new Error(`expected instance of ${e.name}`);n.ptr}(t,k);var r=e.scene_render(_,n,t.ptr);return O.__wrap(r)}}n.Scene=R;class k{static __wrap(n){const e=Object.create(k.prototype);return e.ptr=n,e}free(){const n=this.ptr;this.ptr=0,e.__wbg_workerpool_free(n)}constructor(n){var t=e.workerpool_new(n);return k.__wrap(t)}}n.WorkerPool=k,wasm_bindgen=Object.assign(async function n(_,i){if(void 0===_){let n;_=(n="undefined"==typeof document?location.href:document.currentScript.src).replace(/\.js$/,"_bg.wasm")}const c={wbg:{}};c.wbg.__wbindgen_json_serialize=function(n,t){const _=r(t);var i=s(JSON.stringify(void 0===_?null:_),e.__wbindgen_malloc,e.__wbindgen_realloc),c=o;w()[n/4+1]=c,w()[n/4+0]=i},c.wbg.__wbindgen_object_drop_ref=function(n){f(n)},c.wbg.__wbg_new_4a427f78a4b9f188=j(function(n,e,t){return p(new ImageData(r(n),e,t))}),c.wbg.__wbg_log_f6f1d3a6cdf02ec3=function(n,e){console.log(d(n,e))},c.wbg.__wbg_log_4cec7c845cfbbd2b=function(n){console.log(r(n))},c.wbg.__wbindgen_string_new=function(n,e){return p(d(n,e))},c.wbg.__wbindgen_object_clone_ref=function(n){return p(r(n))},c.wbg.__wbindgen_cb_drop=function(n){const e=f(n).original;return 1==e.cnt--&&(e.a=0,!0)},c.wbg.__wbindgen_number_new=function(n){return p(n)},c.wbg.__wbindgen_jsval_eq=function(n,e){return r(n)===r(e)},c.wbg.__wbg_waitAsync_b79056d359ceb213=function(){return p(Atomics.waitAsync)},c.wbg.__wbindgen_is_undefined=function(n){return void 0===r(n)},c.wbg.__wbg_waitAsync_8469f5fdd593eeda=function(n,e,t){return p(Atomics.waitAsync(r(n),e,t))},c.wbg.__wbg_async_44a449a5287a063c=function(n){return r(n).async},c.wbg.__wbg_value_f5e7d3ea08240a41=function(n){return p(r(n).value)},c.wbg.__wbg_new_59cb74e423758ede=function(){return p(new Error)},c.wbg.__wbg_stack_558ba5917b466edd=function(n,t){var _=s(r(t).stack,e.__wbindgen_malloc,e.__wbindgen_realloc),i=o;w()[n/4+1]=i,w()[n/4+0]=_},c.wbg.__wbg_error_4bb6c2a97407129a=function(n,t){try{console.error(d(n,t))}finally{e.__wbindgen_free(n,t)}},c.wbg.__wbg_postMessage_2ef1c966ea64e040=j(function(n,e){r(n).postMessage(r(e))}),c.wbg.__wbg_instanceof_ErrorEvent_00ac29eb3376db3e=function(n){return r(n)instanceof ErrorEvent},c.wbg.__wbg_message_1afae137078af55c=function(n,t){var _=s(r(t).message,e.__wbindgen_malloc,e.__wbindgen_realloc),i=o;w()[n/4+1]=i,w()[n/4+0]=_},c.wbg.__wbg_newwithstrsequenceandoptions_5ba747362f573cc7=j(function(n,e){return p(new Blob(r(n),r(e)))}),c.wbg.__wbg_createObjectURL_5da9416cd8a4fe8e=j(function(n,t){var _=s(URL.createObjectURL(r(t)),e.__wbindgen_malloc,e.__wbindgen_realloc),i=o;w()[n/4+1]=i,w()[n/4+0]=_}),c.wbg.__wbg_instanceof_MessageEvent_ea82099ef1bbd8dd=function(n){return r(n)instanceof MessageEvent},c.wbg.__wbg_data_5c896013c39c6e21=function(n){return p(r(n).data)},c.wbg.__wbg_type_87b46befe1aeda23=function(n,t){var _=s(r(t).type,e.__wbindgen_malloc,e.__wbindgen_realloc),i=o;w()[n/4+1]=i,w()[n/4+0]=_},c.wbg.__wbg_setonmessage_a5e2ce3d5c7d9d47=function(n,e){r(n).onmessage=r(e)},c.wbg.__wbg_setonerror_3358b238848af687=function(n,e){r(n).onerror=r(e)},c.wbg.__wbg_new_c71b97727ec559aa=j(function(n,e){return p(new Worker(d(n,e)))}),c.wbg.__wbg_postMessage_2dafa7fa6cdd0342=j(function(n,e){r(n).postMessage(r(e))}),c.wbg.__wbg_call_951bd0c6d815d6f1=j(function(n,e){return p(r(n).call(r(e)))}),c.wbg.__wbg_self_6baf3a3aa7b63415=j(function(){return p(self.self)}),c.wbg.__wbg_window_63fc4027b66c265b=j(function(){return p(window.window)}),c.wbg.__wbg_globalThis_513fb247e8e4e6d2=j(function(){return p(globalThis.globalThis)}),c.wbg.__wbg_global_b87245cd886d7113=j(function(){return p(global.global)}),c.wbg.__wbg_newnoargs_7c6bd521992b4022=function(n,e){return p(new Function(d(n,e)))},c.wbg.__wbg_encodeURIComponent_5fa08291cdaa68ea=function(n,e){return p(encodeURIComponent(d(n,e)))},c.wbg.__wbg_new_9dff83a08f5994f3=function(){return p(new Array)},c.wbg.__wbg_of_402bd040ff712561=function(n,e,t){return p(Array.of(r(n),r(e),r(t)))},c.wbg.__wbg_push_3ddd8187ff2ff82d=function(n,e){return r(n).push(r(e))},c.wbg.__wbg_call_bf745b1758bb6693=j(function(n,e,t){return p(r(n).call(r(e),r(t)))}),c.wbg.__wbg_new_ba07d0daa0e4677e=function(){return p(new Object)},c.wbg.__wbg_new_bb4e44ef089e45b4=function(n,t){try{var _={a:n,b:t},r=new Promise((n,t)=>{const r=_.a;_.a=0;try{return function(n,t,_,r){e.wasm_bindgen__convert__closures__invoke2_mut__h5ac244c475e26471(n,t,p(_),p(r))}(r,_.b,n,t)}finally{_.a=r}});return p(r)}finally{_.a=_.b=0}},c.wbg.__wbg_resolve_6e61e640925a0db9=function(n){return p(Promise.resolve(r(n)))},c.wbg.__wbg_then_dd3785597974798a=function(n,e){return p(r(n).then(r(e)))},c.wbg.__wbg_buffer_3f12a1c608c6d04e=function(n){return p(r(n).buffer)},c.wbg.__wbg_new_094130230ad6043d=function(n){return p(new Int32Array(r(n)))},c.wbg.__wbg_new_ae5713b317d1ff86=function(n){return p(new Uint8ClampedArray(r(n)))},c.wbg.__wbg_slice_f3bd284bde6335e4=function(n,e,t){return p(r(n).slice(e>>>0,t>>>0))},c.wbg.__wbg_set_9bdd413385146137=j(function(n,e,t){return Reflect.set(r(n),r(e),r(t))}),c.wbg.__wbindgen_string_get=function(n,t){const _=r(t);var i="string"==typeof _?_:void 0,c=null==i?0:s(i,e.__wbindgen_malloc,e.__wbindgen_realloc),a=o;w()[n/4+1]=a,w()[n/4+0]=c},c.wbg.__wbindgen_debug_string=function(n,t){var _=s(function n(e){const t=typeof e;if("number"==t||"boolean"==t||null==e)return`${e}`;if("string"==t)return`"${e}"`;if("symbol"==t){const n=e.description;return null==n?"Symbol":`Symbol(${n})`}if("function"==t){const n=e.name;return"string"==typeof n&&n.length>0?`Function(${n})`:"Function"}if(Array.isArray(e)){const t=e.length;let _="[";t>0&&(_+=n(e[0]));for(let r=1;r<t;r++)_+=", "+n(e[r]);return _+="]"}const _=/\[object ([^\]]+)\]/.exec(toString.call(e));let r;if(!(_.length>1))return toString.call(e);if("Object"==(r=_[1]))try{return"Object("+JSON.stringify(e)+")"}catch(n){return"Object"}return e instanceof Error?`${e.name}: ${e.message}\n${e.stack}`:r}(r(t)),e.__wbindgen_malloc,e.__wbindgen_realloc),i=o;w()[n/4+1]=i,w()[n/4+0]=_},c.wbg.__wbindgen_throw=function(n,e){throw new Error(d(n,e))},c.wbg.__wbindgen_rethrow=function(n){throw f(n)},c.wbg.__wbindgen_module=function(){return p(n.__wbindgen_wasm_module)},c.wbg.__wbindgen_memory=function(){return p(e.__wbindgen_export_0)},c.wbg.__wbindgen_closure_wrapper249=function(n,e,t){return p(m(n,e,76,y))},c.wbg.__wbindgen_closure_wrapper310=function(n,e,t){return p(m(n,e,102,h))},c.wbg.__wbindgen_closure_wrapper311=function(n,e,t){return p(m(n,e,102,v))},("string"==typeof _||"function"==typeof Request&&_ instanceof Request||"function"==typeof URL&&_ instanceof URL)&&(_=fetch(_));const{instance:a,module:b}=await async function(n,e,_){if("function"==typeof Response&&n instanceof Response){if(t=e.wbg.memory=new WebAssembly.Memory({initial:17,maximum:16384,shared:!0}),"function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(n,e)}catch(e){if("application/wasm"==n.headers.get("Content-Type"))throw e;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",e)}const _=await n.arrayBuffer();return await WebAssembly.instantiate(_,e)}{t=e.wbg.memory=_;const r=await WebAssembly.instantiate(n,e);return r instanceof WebAssembly.Instance?{instance:r,module:n}:r}}(await _,c,i);return e=a.exports,n.__wbindgen_wasm_module=b,e.__wbindgen_start(),e},n)}();self.onmessage=(e=>{console.log(e);let a=wasm_bindgen(...e.data).catch(e=>{throw setTimeout(()=>{throw e}),e});self.onmessage=(async e=>{await a,wasm_bindgen.child_entry_point(e.data)})});"#;

// creates `objectURL` from WORKER_CODE
// https://developer.mozilla.org/en-US/docs/Web/API/Blob/Blob
// https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL
pub fn str_to_blob_url() -> Result<String, JsValue> {
    let data = JsValue::from(WORKER_CODE);
    let arr = Array::new();
    arr.push(&data);

    let mut blob_props = BlobPropertyBag::new();
    blob_props.type_("text/javascript");

    if let Ok(blob) = Blob::new_with_str_sequence_and_options(&arr, &blob_props) {
        let a = Url::create_object_url_with_blob(&blob)?;
        log(&a);
        Ok(a) 
    } else {
        Err(JsValue::from("Error creating Blob"))
    }
}
